# 占い自動鑑定システム開発 WBS（作業分解構成）改訂版

## 改訂履歴
- v1.0: 初版（53日）
- v1.1: レビュー反映版（63日、技術検証フェーズ追加、バッファ拡充）

## プロジェクト概要
- **総工数**: 63日（約13週間）※10日分のバッファ含む
- **開発体制**: エンジニア1名（AIペアプログラミング活用）
- **使用AI**: Claude 3 Sonnet (claude-3-sonnet-20240229)

## 0. 技術検証フェーズ（3日間）【新規追加】

### 0.1 Claude API検証（1日）
- 0.1.1 API接続テスト（0.3日）
- 0.1.2 プロンプトエンジニアリング試行（0.4日）
- 0.1.3 レート制限確認・対策検証（0.3日）

### 0.2 PDF生成検証（1日）
- 0.2.1 React PDF環境構築（0.3日）
- 0.2.2 日本語フォント設定（0.3日）
- 0.2.3 パフォーマンステスト（0.4日）

### 0.3 Stripe連携検証（1日）
- 0.3.1 テストモード設定（0.3日）
- 0.3.2 Webhook動作確認（0.4日）
- 0.3.3 エラーケース確認（0.3日）

## 1. プロジェクト準備フェーズ（5日間）

### 1.1 開発環境構築（2日）
#### 1.1.1 開発PC環境セットアップ（0.5日）
- Node.js v20.x インストール
- VSCode + 拡張機能インストール
  - ESLint
  - Prettier
  - Tailwind CSS IntelliSense
  - Prisma
- Git設定（ユーザー情報、SSH鍵）

#### 1.1.2 プロジェクト初期設定（1日）
- Next.js 14 プロジェクト作成（TypeScript）
- ディレクトリ構造設定
- TypeScript設定（tsconfig.json）
- ESLint/Prettier設定
- Tailwind CSS設定
- 環境変数ファイル作成（.env.local）

#### 1.1.3 開発ツール設定（0.5日）
- GitHubリポジトリ作成
- ブランチ戦略設定
- Vercelアカウント作成
- Vercel-GitHub連携
- 開発/本番環境変数設定

### 1.2 外部サービス準備（2日）
#### 1.2.1 Supabase設定（0.5日）
- アカウント作成
- プロジェクト作成
- データベース接続情報取得
- Row Level Security設定

#### 1.2.2 Stripe設定（0.5日）
- アカウント作成（テスト環境）
- APIキー取得
- Webhookエンドポイント設定
- 商品・価格設定

#### 1.2.3 Anthropic API設定（0.5日）
- APIキー取得
- 利用制限設定
- 料金アラート設定

#### 1.2.4 その他サービス設定（0.5日）
- Resend（メール送信）アカウント作成
- Uploadthing設定
- Sentry設定（エラー監視）

### 1.3 設計ドキュメント作成（1日）
#### 1.3.1 データベース詳細設計（0.5日）
- ER図作成
- テーブル定義書
- インデックス設計

#### 1.3.2 API仕様書作成（0.5日）
- エンドポイント一覧
- リクエスト/レスポンス形式
- エラーコード定義

## 2. 基盤開発フェーズ（10日間）

### 2.1 データベース構築（2日）
#### 2.1.1 Prismaセットアップ（0.5日）
- Prismaインストール
- データベース接続設定
- Prisma Studio設定

#### 2.1.2 スキーマ定義（1日）
- users テーブル
- admins テーブル  
- fortune_requests テーブル
- ai_results テーブル
- fortune_results テーブル
- credit_transactions テーブル
- payment_history テーブル

#### 2.1.3 マイグレーション実行（0.5日）
- 初期マイグレーション
- シードデータ作成
- データベース検証

### 2.2 認証機能実装（3日）
#### 2.2.1 NextAuth.js設定（1日）
- NextAuth.jsインストール
- 認証プロバイダー設定
- セッション管理設定
- JWTトークン設定

#### 2.2.2 ユーザー認証実装（1日）
- ログイン画面UI
- 新規登録画面UI
- パスワードバリデーション
- メール認証フロー
- パスワードリセット機能

#### 2.2.3 管理者認証実装（1日）
- 管理者専用ログイン画面
- 権限管理ミドルウェア
- ロールベースアクセス制御

### 2.3 基本UI構築（3日）
#### 2.3.1 レイアウトコンポーネント（1日）
- ヘッダーコンポーネント
- サイドバーコンポーネント
- フッターコンポーネント
- ナビゲーションメニュー

#### 2.3.2 共通コンポーネント（1日）
- ボタンコンポーネント
- フォーム要素（Input, Select, Textarea）
- モーダルコンポーネント
- 通知（Toast）コンポーネント
- ローディングスピナー

#### 2.3.3 レスポンシブ対応（1日）
- モバイルメニュー実装
- ブレークポイント設定
- タブレット最適化

### 2.4 APIルート基盤（2日）
#### 2.4.1 tRPC設定（1日）
- tRPCインストール・設定
- ルーター構成
- コンテキスト設定
- 型定義

#### 2.4.2 エラーハンドリング（1日）
- グローバルエラーハンドラー
- カスタムエラークラス
- バリデーション設定（zod）
- ロギング設定

## 3. コア機能開発フェーズ（15日間）

### 3.1 ユーザーダッシュボード（3日）
#### 3.1.1 ダッシュボード画面（1日）
- レイアウト実装
- 占いメニューカード
- お知らせエリア
- クイックアクセス

#### 3.1.2 鑑定履歴機能（1日）
- 履歴一覧表示
- ステータス表示
- ページネーション
- 検索・フィルター

#### 3.1.3 クレジット表示（1日）
- 残高表示ウィジェット
- 使用履歴表示
- 購入ボタン配置

### 3.2 占い申込機能（4日）
#### 3.2.1 占い選択画面（1日）
- 占い種類カード表示
- 詳細説明モーダル
- 必要クレジット表示
- 選択アニメーション

#### 3.2.2 入力フォーム実装（2日）
- 基本情報入力（名前、生年月日、性別）
- 占い別追加項目
  - 九星気学：出生時刻、出生地
  - タロット：具体的な質問
  - 西洋占星術：出生時刻、緯度経度
  - 四柱推命：出生時刻
- リアルタイムバリデーション
- 入力補助機能

#### 3.2.3 確認・完了画面（1日）
- 入力内容確認画面
- クレジット消費確認
- 申込完了画面
- 完了通知メール送信

### 3.3 Claude API連携（4日）
#### 3.3.1 API通信実装（1日）
- Anthropic SDK設定
- API通信関数作成
- リトライ処理
- タイムアウト設定

#### 3.3.2 プロンプトテンプレート（1日）
- 九星気学用プロンプト
- タロット用プロンプト
- 西洋占星術用プロンプト
- 四柱推命用プロンプト
- 変数置換処理

#### 3.3.3 鑑定文生成処理（1日）
- 非同期ジョブ実装
- キューイングシステム
- 進捗状態管理
- 生成結果保存

#### 3.3.4 レート制限対策（1日）
- APIコール数管理
- 待機キュー実装
- エラーハンドリング
- 代替処理

### 3.4 PDF生成機能（5日）【工数増加：4日→5日】
#### 3.4.1 PDFテンプレート作成（2日）
- デザインレイアウト作成
- ヘッダー/フッターデザイン
- 本文スタイリング
- 日本語フォント設定（Noto Sans JP）

#### 3.4.2 PDF生成処理（1.5日）【工数増加】
- React PDF実装
- 動的コンテンツ挿入
- ページ分割処理
- ファイルサイズ最適化
- メモリ使用量最適化

#### 3.4.3 PDFプレビュー・ダウンロード（1日）
- プレビュー画面実装
- ダウンロードAPI
- ブラウザ表示対応
- モバイル対応

#### 3.4.4 パフォーマンス最適化（0.5日）【新規追加】
- 生成速度改善
- キャッシュ実装

## 4. 課金機能開発フェーズ（8日間）

### 4.1 クレジット管理（3日）
#### 4.1.1 クレジット付与機能（1日）
- 初回登録3クレジット付与
- 管理者による手動付与
- 付与履歴記録
- 通知機能

#### 4.1.2 クレジット消費処理（1日）
- 占い申込時の消費
- トランザクション処理
- 残高不足チェック
- ロールバック処理

#### 4.1.3 残高確認・履歴表示（1日）
- 残高リアルタイム表示
- 取引履歴一覧
- 履歴詳細表示
- CSV出力機能

### 4.2 Stripe決済実装（5日）
#### 4.2.1 Stripe Checkout実装（2日）
- Checkout Session作成
- 商品・価格設定
- 成功/キャンセルページ
- 決済フロー実装

#### 4.2.2 Webhook処理（1日）
- Webhookエンドポイント実装
- 署名検証
- イベント処理（支払い完了等）
- エラーハンドリング

#### 4.2.3 購入画面UI（1日）
- クレジットパック選択
- 価格表示（割引表示）
- 支払い方法選択
- 利用規約同意

#### 4.2.4 領収書機能（1日）
- 領収書自動生成
- PDFダウンロード
- メール送信
- 再発行機能

## 5. 管理機能開発フェーズ（10日間）

### 5.1 管理者ダッシュボード（2日）
#### 5.1.1 管理画面レイアウト（1日）
- 管理者専用レイアウト
- サイドメニュー
- 権限別表示制御
- ダークモード対応

#### 5.1.2 統計情報表示（1日）
- ユーザー数推移
- 売上グラフ
- 鑑定件数統計
- 人気占い種別

### 5.2 鑑定結果管理（4日）
#### 5.2.1 AI生成結果一覧（1日）
- ステータス別表示
- 検索・フィルター機能
- ソート機能
- 一括操作

#### 5.2.2 編集画面実装（2日）
- リッチテキストエディタ
- AI結果・編集結果比較表示
- 自動保存機能
- 編集履歴管理

#### 5.2.3 承認フロー（1日）
- 承認/差戻し機能
- コメント機能
- 承認履歴
- 通知機能

### 5.3 ユーザー管理（2日）
#### 5.3.1 ユーザー一覧・検索（1日）
- ユーザー一覧表示
- 詳細検索機能
- ステータス管理
- エクスポート機能

#### 5.3.2 ユーザー詳細・編集（1日）
- プロフィール編集
- クレジット手動付与
- アカウント停止/復活
- 活動履歴表示

### 5.4 売上レポート（2日）
#### 5.4.1 日次・月次集計（1日）
- 売上集計処理
- 期間指定機能
- 前期比較
- KPI表示

#### 5.4.2 グラフ表示（1日）
- Chart.js実装
- 売上推移グラフ
- 占い種別売上
- ダウンロード機能

## 6. 占い種類拡張フェーズ（5日間）

### 6.1 タロット占い（1.5日）
#### 6.1.1 入力フォーム実装（0.5日）
- 質問種別選択
- 具体的な悩み入力
- カードスプレッド選択

#### 6.1.2 プロンプトテンプレート（0.5日）
- タロット専用プロンプト
- カード解釈ロジック
- 結果フォーマット

#### 6.1.3 結果表示調整（0.5日）
- カード画像表示
- 解釈文表示
- PDF出力調整

### 6.2 西洋占星術（1.5日）
#### 6.2.1 入力フォーム実装（0.5日）
- 出生地選択（地図連携）
- タイムゾーン自動設定
- 詳細情報入力

#### 6.2.2 プロンプトテンプレート（0.5日）
- ホロスコープ解釈
- アスペクト分析
- 運勢予測

#### 6.2.3 結果表示調整（0.5日）
- チャート表示
- 星座記号表示
- 詳細解説表示

### 6.3 四柱推命（2日）
#### 6.3.1 入力フォーム実装（0.5日）
- 旧暦変換機能
- 時刻入力補助
- 出生地情報

#### 6.3.2 プロンプトテンプレート（1日）
- 命式計算ロジック
- 五行バランス分析
- 大運・年運解釈

#### 6.3.3 結果表示調整（0.5日）
- 命式表表示
- 五行グラフ
- 詳細解説

## 7. テスト・改善フェーズ（10日間）【工数増加：7日→10日】

### 7.1 単体テスト（3日）【工数増加】
#### 7.1.1 コンポーネントテスト（1.5日）
- React Testing Library設定
- UIコンポーネントテスト
- カスタムフックテスト
- スナップショットテスト
- カバレッジ80%達成

#### 7.1.2 APIテスト（1.5日）
- APIルートテスト
- 認証テスト
- データベーステスト
- モックデータ作成
- エラーケーステスト

### 7.2 統合テスト（3日）【工数増加】
#### 7.2.1 E2Eテスト実装（1.5日）
- Playwright設定
- 主要フローテスト
- クロスブラウザテスト
- モバイルテスト
- エラーシナリオテスト

#### 7.2.2 決済フローテスト（1.5日）
- Stripeテストモード
- 成功/失敗ケース
- Webhook動作確認
- エラーリカバリー
- 返金フローテスト

### 7.3 パフォーマンス改善（2日）
#### 7.3.1 ページ速度最適化（1日）
- Lighthouse分析
- 画像最適化
- コード分割
- キャッシュ設定

#### 7.3.2 データベースクエリ最適化（1日）
- クエリ分析
- インデックス追加
- N+1問題解決
- 接続プール調整

### 7.4 セキュリティ対策（2日）【工数増加】
#### 7.4.1 脆弱性診断（1日）
- 依存関係チェック
- OWASP対策確認
- ペネトレーションテスト
- セキュリティスキャン

#### 7.4.2 セキュリティ修正（1日）
- 脆弱性修正
- セキュリティヘッダー設定
- CSP設定
- 監査ログ確認

## 8. リリース準備フェーズ（3日間）

### 8.1 本番環境構築（1日）
#### 8.1.1 環境変数設定（0.3日）
- 本番用API キー設定
- データベース接続設定
- 環境別設定確認

#### 8.1.2 ドメイン設定（0.3日）
- ドメイン取得
- DNS設定
- SSL証明書設定

#### 8.1.3 バックアップ設定（0.4日）
- データベースバックアップ
- ファイルバックアップ
- 復元手順確認

### 8.2 ドキュメント整備（1日）
#### 8.2.1 利用規約作成（0.3日）
- サービス利用規約
- 免責事項
- 法務確認

#### 8.2.2 プライバシーポリシー（0.3日）
- 個人情報取扱
- Cookie使用
- 第三者提供

#### 8.2.3 特定商取引法表記（0.4日）
- 事業者情報
- 販売条件
- 返品・キャンセル

### 8.3 リリース作業（1日）
#### 8.3.1 本番デプロイ（0.3日）
- Vercelデプロイ
- 環境変数確認
- ビルド確認

#### 8.3.2 動作確認（0.4日）
- 全機能テスト
- 決済動作確認
- メール送信確認

#### 8.3.3 モニタリング設定（0.3日）
- Vercel Analytics
- Sentry設定
- アラート設定